name: CI/CD for HR-Web

on:
  push:
    branches: [main]  # Trigger the CI pipeline on push to main branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Repository
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@v3

      # 2. Install Dependencies
      - name: ğŸ“¦ Install Dependencies
        run: npm install

      # 3. Run Tests
      - name: ğŸ§ª Run Tests
        run: npm run test

      # 4. Lint Code
      - name: ğŸ§¹ Lint Code
        run: npm run lint

      # 5. Build App
      - name: ğŸ› ï¸ Build App
        run: npm run build

      # 6. Build Docker Image
      - name: ğŸ³ Build Docker Image
        run: |
          docker build -t ghcr.io/amashr-dev/hr-web:${{ github.sha }} .
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ghcr.io/amashr-dev/hr-web:${{ github.sha }}

      # 7. Update image tag in hr-k8s-pipeline (Inline Script)
      - name: ğŸ“˜ Update image tag in hr-k8s-pipeline
        run: |
          git clone https://x-access-token:${{ secrets.K8S_REPO_PAT }}@github.com/amashr-dev/hr-k8s-pipeline.git
          cd hr-k8s-pipeline
          branch="update-${{ github.sha }}"
          git checkout -b "$branch"
          yq e -i ".image.tag = \"${{ github.sha }}\"" k8s/charts/frontend/hr-web/values.yaml
          git add k8s/charts/frontend/hr-web/values.yaml
          git commit -m "chore: bump hr-web image tag to ${{ github.sha }}"
          git push origin "$branch"

      # 8. Create Pull Request
      - name: ğŸ“¤ Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.K8S_REPO_PAT }}
          commit-message: "chore: bump hr-web image tag"
          title: "Update hr-web image tag"
          body: "Auto-generated PR to update image tag for hr-web"
          branch: update-${{ github.sha }}
          path: hr-k8s-pipeline
