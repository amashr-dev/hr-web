name: CI/CD for HR-Web

on:
  push:
    branches: [main]  # Only on main branch pushes

permissions:
  contents: write  # Needed to commit and create PR
  pull-requests: write  # Needed to create PR

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout current repo
      - name: ğŸ›ï¸ Checkout Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Install Dependencies
      - name: ğŸ“¦ Install Dependencies
        run: npm install

      # 3. Build App
      - name: ğŸ› ï¸ Build App
        run: npm run build

      # 4. Build and Push Docker Image
      - name: ğŸ³ Build and Push Docker Image
        run: |
          docker build -t ghcr.io/amashr-dev/hr-web:${{ github.sha }} .
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ghcr.io/amashr-dev/hr-web:${{ github.sha }}

      # 5. Checkout hr-k8s-pipeline repository
      - name: ğŸ›ï¸ Checkout hr-k8s-pipeline repo
        uses: actions/checkout@v3
        with:
          repository: amashr-dev/hr-k8s-pipeline
          token: ${{ secrets.K8S_REPO_PAT }}
          path: hr-k8s-pipeline

      # 6. Update YAML file
      - name: ğŸ› ï¸ Update Image Tag
        run: |
          cd hr-k8s-pipeline
          yq e -i ".image.tag = \"${{ github.sha }}\"" k8s/charts/frontend/hr-web/values.yaml

      # 7. Create Pull Request
      - name: ğŸ“¤ Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.K8S_REPO_PAT }}
          path: hr-k8s-pipeline
          commit-message: "chore: bump hr-web image tag to ${{ github.sha }}"
          title: "Update hr-web image tag"
          body: "Auto-generated PR to update image tag for hr-web to `${{ github.sha }}`"
          branch: update-${{ github.sha }}
